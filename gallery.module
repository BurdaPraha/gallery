<?php

use Drupal\Core\Url;
use Drupal\image\Entity\ImageStyle;

use Drupal\gallery\Navigation;
use Drupal\gallery\Gallery;


/**
 * todo: add loading gallery thumbs here with "gallery_photo_preview"
 * @param $variables
 */
function gallery_preprocess_media(&$variables)
{
    // gallery embed as paragraph in article
    if(
        isset($variables['content']['name']) &&
        'burda_gallery_in_paragraphs' == $variables['content']['name']['#view_mode'])
    {
        $gallery_id     = $variables['content']['name']['#object']->id();
        $relative_url   = \Drupal::service('path_alias.manager')->getAliasByPath('/media/' . $gallery_id);
        $absolute_url   = Url::fromUri('base:/' . $relative_url, array('absolute' => TRUE));

        $variables['gallery_url'] = $absolute_url->toString();
    }

    // gallery detail page
    if(
        isset($variables['content']['field_media_images']) &&
        'full' === $variables['elements']['#view_mode']
    )
    {
        $formatter = $variables['content']['field_media_images']['#formatter'];
        if('entity_reference_entity_view' !== $formatter || 'media_thumbnail' !== $formatter) {
            new Exception('Gallery field Media Images must be in format Thumbnail or Render Entity! Fix it: /admin/structure/media/manage/gallery/display');
        }

        $thumbs = [];
        foreach($variables['content']['field_media_images'] as $key => $values)
        {
            if('#' !== substr($key, 0, 1))
            {
                if('image_formatter' === $values['#theme']) {
                    $media  = $values['#item']->getEntity();
                }

                if('media' === $values['#theme']){
                    $media  = $values['#media'];
                }

                $thumbs[] = [
                    'mid'   => $media->id(),
                    'thumb' => ImageStyle::load('gallery_thumbnail_on_detail')->buildUrl(Gallery::mediaFileUrl($media))
                ];
            };
        }
        $variables['gallery_thumbs'] = $thumbs;


        //
        // cross-gallery pagination
        //
        $gallery = \Drupal::routeMatch()->getParameter('media');
        $variables['gallery_prev'] = Gallery::loadNext($gallery->id());
        $variables['gallery_next'] = Gallery::loadPrev($gallery->id());
    }
}


/**
 * Add special layout template support for gallery detail
 * @param $suggestions
 * @param $variables
 */
function gallery_theme_suggestions_page_alter(&$suggestions, &$variables)
{
    $media = \Drupal::routeMatch()->getParameter('media');
    if($media && 'gallery' == $media->bundle()) {
        $suggestions[] = 'page__media__gallery';
    }
}


/**
 * Add special carousel template for gallery item on detail page
 * @param $suggestions
 * @param $variables
 */
function gallery_theme_suggestions_media_alter(&$suggestions, &$variables)
{
    $media = \Drupal::routeMatch()->getParameter('media');
    if($media && 'gallery' == $media->bundle())
    {
        // yeah we have item of field_media_images
        if(array_key_exists('media__image', array_flip($suggestions))){
            $suggestions[] = 'media__image__gallery';
            $suggestions[] = 'media__image__gallery__custom'; // @todo: test overriding by theme
        }
    }
}


/**
 * Get backlink from gallery to her article
 *
 * @param $variables
 */
function gallery_preprocess_page(&$variables)
{
    /**
     *  We are on gallery page?
     */
    $media = \Drupal::routeMatch()->getParameter('media');
    if($media && 'gallery' == $media->bundle())
    {
        /**
         * add absolute link
         */
        $absolute_url = \Drupal::service('path_alias.manager')->getAliasByPath('/media/' . $media->id());
        $absolute_url = Url::fromUri('base:/' . $absolute_url, array('absolute' => TRUE));
        $variables['absolute_url'] = $absolute_url->toString();

        /**
         * Homepage, default backlink, fallback
         */
        $variables['gallery_article_backlink'] = \Drupal\Core\Url::fromRoute('<front>');

        /**
         * backlink from gallery to the article
         */
        $query = \Drupal::request()->query;
        $from = $query->get('bnid');

        if($from)
        {
            $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => $from]);
            if($url)
            {
                $variables['gallery_article_backlink'] = $url->toString();
            }
        }
        else
        {
            /**
             * Find gallery used in paragraph
             */
            $paragraph = \Drupal::entityQuery('paragraph')
                ->condition('field_media', $media->id())
                ->execute();

            if($paragraph)
            {
                /**
                 * Find node where is paragraph used
                 */
                $find_node = \Drupal::entityQuery('node')
                    ->condition('field_paragraphs', array(end($paragraph)), 'IN')
                    ->execute();

                if($find_node)
                {
                    $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => end($find_node)]);
                    if($url)
                    {
                        $variables['gallery_article_backlink'] = $url->toString();
                    }
                }
            }
        }
    }
}