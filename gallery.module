<?php

/**
 * Get backlink from gallery to her article
 *
 * @param $variables
 * @return string - relative URL
 */
function gallery_preprocess_page(&$variables)
{
    /**
     * backlink from gallery to the article
     */
    $query = \Drupal::request()->query;
    $from = $query->get('bnid');

    /**
     * Homepage, default backlink, fallback
     */
    $variables['preprocess_article_backlink'] = \Drupal::url('<front>');

    if($from)
    {
        $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => $from]);
        if($url)
        {
            $variables['preprocess_article_backlink'] = $url->toString();
        }
    }
    else
    {
        /**
         *  We are on gallery page?
         */
        $media = \Drupal::routeMatch()->getParameter('media');
        if($media)
        {
            /**
             * Find gallery used in paragraph
             */
            $paragraph = \Drupal::entityQuery('paragraph')
                ->condition('field_media', $media->id())
                ->execute();

            if($paragraph)
            {
                /**
                 * Find node where is paragraph used
                 */
                $find_node = \Drupal::entityQuery('node')
                    ->condition('field_paragraphs', array(end($paragraph)), 'IN')
                    ->execute();

                if($find_node)
                {
                    $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => end($find_node)]);
                    if($url)
                    {
                        $variables['preprocess_article_backlink'] = $url->toString();
                    }
                }
            }
        }
    }
}

/**
 * Paragraphs - Gallery item
 * @param $variables
 */
function gallery_preprocess_paragraph(&$variables)
{
    $paragraph = $variables['paragraph'];
    $bundle = $paragraph->bundle();

    if ($bundle == 'gallery')
    {
        // todo
    }
}