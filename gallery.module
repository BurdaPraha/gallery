<?php

use Drupal\Core\Url;
use Drupal\image\Entity\ImageStyle;
use Drupal\Core\File;
use Drupal\media_entity\MediaInterface;
use Drupal\gallery\Navigation;


/**
 * @param MediaInterface $media_entity
 * @return string|null
 */
function mediaFileUrl(MediaInterface $media_entity)
{
    $source_field = $media_entity->getType()->getConfiguration()['source_field'];

    if ($media_entity->hasField($source_field))
    {
        $file_entities = $media_entity->get($source_field)->referencedEntities();
        if (!empty($file_entities)) {
            return $file_entities[0]->getFileUri();
        }
    }

    return null;
}


/**
 * todo: add loading gallery thumbs here with "gallery_photo_preview"
 * @param $variables
 */
function gallery_preprocess_media(&$variables)
{
    // gallery embed as paragraph in article
    if(
        isset($variables['content']['name']) &&
        'burda_gallery_in_paragraphs' == $variables['content']['name']['#view_mode'])
    {
        $gallery_id     = $variables['content']['name']['#object']->id();
        $relative_url   = \Drupal::service('path.alias_manager')->getAliasByPath('/media/' . $gallery_id);
        $absolute_url   = Url::fromUri('base:/' . $relative_url, array('absolute' => TRUE));

        $variables['gallery_url'] = $absolute_url->toString();
    }

    // gallery detail page
    if(
        isset($variables['content']['field_media_images']) &&
        'full' === $variables['elements']['#view_mode']
    )
    {
        $formatter = $variables['content']['field_media_images']['#formatter'];
        if('entity_reference_entity_view' !== $formatter || 'media_thumbnail' !== $formatter) {
            new Exception('Gallery field Media Images must be in format Thumbnail or Render Entity! Fix it: /admin/structure/media/manage/gallery/display');
        }

        $thumbs = [];
        foreach($variables['content']['field_media_images'] as $key => $values)
        {
            if('#' !== substr($key, 0, 1))
            {
                if('image_formatter' === $values['#theme']) {
                    $media  = $values['#item']->getEntity();
                }

                if('media' === $values['#theme']){
                    $media  = $values['#media'];
                }

                $thumbs[] = [
                    'mid'   => $media->id(),
                    'thumb' => ImageStyle::load('gallery_thumbnail_on_detail')->buildUrl(mediaFileUrl($media))
                ];
            };
        }

        $variables['gallery_thumbs'] = $thumbs;
    }
}


/**
 * Get backlink from gallery to her article
 *
 * @param $variables
 * @return string - relative URL
 */
function gallery_preprocess_page(&$variables)
{
    /**
     *  We are on gallery page?
     */
    $media = \Drupal::routeMatch()->getParameter('media');
    if($media && 'gallery' == $media->bundle())
    {
        /**
         * add absolute link
         */
        $absolute_url = \Drupal::service('path.alias_manager')->getAliasByPath('/media/' . $media->id());
        $absolute_url = Url::fromUri('base:/' . $absolute_url, array('absolute' => TRUE));
        $variables['absolute_url'] = $absolute_url->toString();

        /**
         * Homepage, default backlink, fallback
         */
        $variables['preprocess_article_backlink'] = \Drupal::url('<front>');

        /**
         * backlink from gallery to the article
         */
        $query = \Drupal::request()->query;
        $from = $query->get('bnid');

        if($from)
        {
            $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => $from]);
            if($url)
            {
                $variables['preprocess_article_backlink'] = $url->toString();
            }
        }
        else
        {
            /**
             * Find gallery used in paragraph
             */
            $paragraph = \Drupal::entityQuery('paragraph')
                ->condition('field_media', $media->id())
                ->execute();

            if($paragraph)
            {
                /**
                 * Find node where is paragraph used
                 */
                $find_node = \Drupal::entityQuery('node')
                    ->condition('field_paragraphs', array(end($paragraph)), 'IN')
                    ->execute();

                if($find_node)
                {
                    $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => end($find_node)]);
                    if($url)
                    {
                        $variables['preprocess_article_backlink'] = $url->toString();
                    }
                }
            }
        }
    }
}